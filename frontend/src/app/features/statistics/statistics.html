<div class="page-wrap">
  <h1 class="page-title gradient-text">Statistics</h1>

  <div class="app-card with-accent">
    <div class="card-header">
      <button class="back-btn" type="button" (click)="goBack()" aria-label="Back">
        <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round"
          stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6" />
        </svg>
        <span>Back</span>
      </button>
      <div class="header-actions">
        <button class="btn--ghost" type="button" (click)="load()" [disabled]="loading()">Refresh</button>
      </div>
    </div>

    <div class="alert alert-error" *ngIf="error()" aria-live="assertive">
      <span class="alert__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      </span>
      {{ error() }}
    </div>

    <ng-container *ngIf="!loading(); else loadingTpl">
      <ng-container *ngIf="data() as d">
        <div class="stats-grid" role="list">
          <div class="stat-card" role="listitem" aria-label="Total users">
            <span class="stat-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.75" stroke-linecap="round"
                stroke-linejoin="round">
                <circle cx="9" cy="7" r="4" />
                <path d="M16 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" />
                <circle cx="17" cy="11" r="3" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
              </svg>
            </span>
            <span class="stat-label">Total Users</span>
            <span class="stat-value">{{ d.totalUsers }}</span>
          </div>
          <div class="stat-card" role="listitem" aria-label="Total roles">
            <span class="stat-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.75" stroke-linecap="round"
                stroke-linejoin="round">
                <path d="M12 3 5 6v5c0 5 3.6 9.4 7 10 3.4-.6 7-5 7-10V6l-7-3Z" />
                <path d="M9.5 12l2 2 3.5-3.5" />
              </svg>
            </span>
            <span class="stat-label">Total Roles</span>
            <span class="stat-value">{{ d.totalRoles }}</span>
          </div>
          <div class="stat-card" role="listitem" aria-label="Total permissions">
            <span class="stat-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.75" stroke-linecap="round"
                stroke-linejoin="round">
                <circle cx="9" cy="12" r="4" />
                <path d="M13 12h7v2h-2v2h-2v-2h-3z" />
              </svg>
            </span>
            <span class="stat-label">Total Permissions</span>
            <span class="stat-value">{{ d.totalPermissions }}</span>
          </div>
          <div class="stat-card" role="listitem" aria-label="Total categories">
            <span class="stat-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.75" stroke-linecap="round"
                stroke-linejoin="round">
                <rect x="4" y="4" width="6" height="6" rx="1" />
                <rect x="14" y="4" width="6" height="6" rx="1" />
                <rect x="4" y="14" width="6" height="6" rx="1" />
                <rect x="14" y="14" width="6" height="6" rx="1" />
              </svg>
            </span>
            <span class="stat-label">Total Categories</span>
            <span class="stat-value">{{ d.totalCategories }}</span>
          </div>
        </div>

        <div class="chart-section" role="region" aria-label="User analytics charts">
          <div class="chart-card" role="group" aria-label="Active inactive user donut">
            <h2 class="chart-title">User Activity</h2>
            <div class="donut-layout" *ngIf="d.totalUsers > 0; else noUsers">
              <div class="donut-wrapper">
                <svg class="donut" viewBox="0 0 42 42" role="img" aria-labelledby="donutTitle">
                  <title id="donutTitle">Active vs Inactive Users</title>
                  <circle class="donut-ring" cx="21" cy="21" r="15.915" />
                  <circle class="donut-segment-active" cx="21" cy="21" r="15.915"
                    [attr.stroke-dasharray]="donutPerc().active + ' ' + donutPerc().inactive" stroke-dashoffset="25" />
                </svg>
                <div class="donut-center">
                  <span class="main">{{ d.activeUsers }}</span>
                  <span class="sub">Active</span>
                </div>
              </div>
              <div class="donut-info">
                <div class="legend">
                  <div class="legend-item">
                    <span class="dot active"></span>
                    <span>Active ({{ donutPerc().active | number:'1.0-0' }}%)</span>
                  </div>
                  <div class="legend-item">
                    <span class="dot inactive"></span>
                    <span>Inactive ({{ donutPerc().inactive | number:'1.0-0' }}%)</span>
                  </div>
                </div>
                <div class="legend-footer">
                  <span class="muted small">Total {{ d.totalUsers }} users</span>
                </div>
              </div>
            </div>
            <ng-template #noUsers>
              <div class="muted small">No users yet.</div>
            </ng-template>
          </div>

          <div class="chart-card" role="group" aria-label="Users by role bar chart">
            <h2 class="chart-title">Users by Role</h2>
            <div *ngIf="d.roleDistribution?.length; else noRolesDist" class="bars">
              <div class="bar-row" *ngFor="let r of d.roleDistribution; trackBy: trackRole">
                <span class="bar-label truncate" [title]="r.role">{{ r.role }}</span>
                <div class="bar-track">
                  <div class="bar-fill" [style.width.%]="barWidth(r)"></div>
                </div>
                <span class="bar-value">{{ r.count }}</span>
              </div>
            </div>
            <ng-template #noRolesDist>
              <div class="muted small">No role assignments.</div>
            </ng-template>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="app-card with-accent skeleton">
    <div class="skeleton-line wide"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line half"></div>
  </div>
</ng-template>